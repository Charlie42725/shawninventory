# 库存与成本系统修复总结

## 🎯 修复的问题

### 1. 销售成本计算错误（最严重）
**问题**: 损益报表使用产品**当前**的平均成本计算历史销售的成本
- ❌ 售完后再进货，新进货的成本会影响历史销售的 COGS 计算
- ❌ 导致毛利和净利计算不准确

**解决**:
- ✅ 在 `sales` 表添加 `cost_of_goods_sold` 字段
- ✅ 销售时记录实际成本，永久保存
- ✅ 损益报表优先使用保存的 COGS
- ✅ 符合会计的**成本配比原则**

### 2. size_stock 扣减错误
**问题**: 销售时如果 size 字段为空，不会扣减 size_stock
- ❌ total_stock 减少了，但 size_stock 没变
- ❌ 导致库存不一致

**解决**:
- ✅ 修改 `inventory-utils.ts:227-246`
- ✅ size 为空时使用 'default' 作为 key 扣减
- ✅ total_stock 从 size_stock 计算，保证一致性

### 3. 售完后平均成本变0
**问题**: 之前的逻辑在售完时将 avg_unit_cost 设为 0
- ❌ 后续无法为历史销售补充正确的 COGS
- ❌ 再进货时无法正确计算加权平均成本

**解决**:
- ✅ 修改 `inventory-utils.ts:254-255`
- ✅ 售完后保持 avg_unit_cost 不变
- ✅ 只将 total_cost_value 清零

---

## ✅ 已完成的修复

### 数据库修改
```sql
ALTER TABLE sales
ADD COLUMN cost_of_goods_sold DECIMAL(10, 2) DEFAULT 0;
```
✅ 已执行（通过 Supabase Dashboard）

### 代码修改
1. ✅ `src/lib/inventory-utils.ts:170-184` - processSale 函数签名添加 COGS 参数
2. ✅ `src/lib/inventory-utils.ts:223-246` - 修复 size_stock 扣减逻辑
3. ✅ `src/lib/inventory-utils.ts:248-260` - 销售时计算并保存 COGS
4. ✅ `src/app/api/reports/route.ts:4-23` - 损益报表使用保存的 COGS

### 数据修复
1. ✅ LabubuA組合 (ID: 84) - 修复库存和成本
   - 进货总计: 30个，总成本: $90,900
   - 平均成本: $3,030/个
   - 当前库存: 27个
   - 总成本价值: $81,810

2. ✅ LabubuB組合 (ID: 85) - 修复库存和成本
   - 进货总计: 31个，总成本: $104,900
   - 平均成本: $3,384/个
   - 当前库存: 28个
   - 总成本价值: $94,748

3. ✅ 历史销售记录 COGS 补充
   - 总计: 60条销售记录
   - 已补充: 59条 (98.3%)
   - 未补充: 1条（Labubu組合B，无进货记录）

---

## 📊 验证结果

### 销售记录 COGS 完整性
- ✅ **98.3%** 的销售记录有 COGS
- ⚠️ 1条记录无 COGS（Labubu組合B，需手动处理）

### 损益报表准确性
- 最近一个月收入: **$877,010**
- 销售成本 (COGS): **$738,061**
- 毛利: **$138,949**
- 毛利率: **15.8%**

### 特殊案例处理
- ✅ 3个售完产品保留了平均成本
- ✅ 即使售完后再进货，历史销售成本不受影响

---

## ⚠️ 待处理项目

### 1. Labubu組合B (ID: 3)
**问题**: 没有进货记录，无法计算平均成本

**建议**:
- 方案1: 在系统中补充进货记录
- 方案2: 手动设置平均成本（从销售价推算）
- 方案3: 删除该产品，使用正确的产品名称（可能是 LabubuB組合）

**SQL 手动设置成本（示例）**:
```sql
-- 如果估算成本为 $3000/个
UPDATE products
SET avg_unit_cost = 3000,
    total_cost_value = 3000 * total_stock
WHERE id = 3;

-- 然后补充销售 ID 15 的 COGS
UPDATE sales
SET cost_of_goods_sold = 3000 * quantity
WHERE id = 15;
```

---

## 🎉 修复效果

### 符合会计原则 ✅
1. **成本配比原则**: 销售收入配比销售时的实际成本
2. **历史成本原则**: 成本在交易发生时确定，不受后续事件影响
3. **一致性原则**: 所有销售使用相同的成本计算方法

### 解决实际业务问题 ✅
**场景**: LabubuB組合售完后又进货

| 时间 | 操作 | 修复前 COGS | 修复后 COGS |
|------|------|-------------|-------------|
| 11/23 | 进货3个@$3300 | - | - |
| 11/23 | 售出3个 | $3300×3 = $9,900 | $3300×3 = **$9,900** ✅ |
| 11/24 | 进货28个@$3392 | avg_cost=$3384 | avg_cost=$3384 |
| 11/24 | 售出28个 | $3384×28 = **$94,752** | $3384×28 = **$94,752** ✅ |
| 11/24 | 售完（库存=0） | avg_cost=**0** ❌ | avg_cost=**$3384** ✅ |
| 12/01 | 再进货10个@$4000 | avg_cost=$4000 | avg_cost=$4000 |
| 查看11/23销售 | COGS? | **$4000×3=$12,000** ❌ | **$9,900** ✅ |
| 查看11/24销售 | COGS? | **$4000×28=$112,000** ❌ | **$94,752** ✅ |

**差异**:
- 修复前会高估 COGS **$18,348**
- 修复后使用实际销售时的成本，准确！

---

## 📝 使用说明

### 日常操作（无需额外动作）
- ✅ 创建销售：自动记录 COGS
- ✅ 查看损益表：自动使用正确的 COGS
- ✅ 售完再进货：历史销售成本不受影响

### 定期检查（建议每月一次）
```bash
node verify-cogs-fix.js
```

### 如果需要重新计算产品成本
```bash
# 仅重新计算产品的平均成本（不影响历史销售 COGS）
node fix-complete-inventory-issues.js
```

**重要**: 不要重新运行 `backfill-sales-cogs.js`，这会覆盖历史 COGS！

---

## 🛠️ 修复工具说明

| 脚本名称 | 用途 | 何时使用 |
|---------|------|---------|
| `add-cogs-to-database.sql` | 添加 COGS 字段 | ✅ 已执行（一次性） |
| `fix-complete-inventory-issues.js` | 修复库存和成本不一致 | ✅ 已执行 |
| `backfill-sales-cogs.js` | 补充历史销售 COGS | ✅ 已执行（一次性） |
| `verify-cogs-fix.js` | 验证修复结果 | 🔄 定期运行 |
| `debug-zero-cost-products.js` | 调试成本为0的产品 | 🆘 故障排查 |

---

## 📈 预期改进

### 财务报表准确性
- ✅ 毛利计算准确
- ✅ 净利计算准确
- ✅ 符合会计准则，可用于税务申报

### 业务决策支持
- ✅ 准确的产品盈利分析
- ✅ 正确的定价策略依据
- ✅ 真实的库存价值评估

### 系统稳定性
- ✅ 库存数据一致性提高
- ✅ 售完后再进货不会出错
- ✅ 减少数据修复频率

---

## 🎓 经验总结

### 为什么之前的方法有问题？
1. **动态成本**: 用产品当前成本计算历史销售，成本会"时光倒流"
2. **售完清零**: 售完时清零成本，丢失了成本信息
3. **库存不同步**: size_stock 和 total_stock 各自更新，容易不一致

### 正确的做法
1. **固化成本**: 销售时记录成本，永久保存
2. **保留历史**: 售完也保留平均成本，用于新进货的加权计算
3. **单一来源**: total_stock 从 size_stock 计算，避免不一致

---

## ✅ 检查清单

修复完成确认：

- [x] SQL 字段已添加 (`cost_of_goods_sold`)
- [x] 代码已修改并部署
- [x] 历史数据已补充 (98.3%)
- [x] 新销售自动记录 COGS
- [x] 损益报表使用实际 COGS
- [x] 售完产品保留平均成本
- [x] 库存同步问题已修复
- [x] 验证脚本运行正常

---

## 📞 后续支持

如遇到问题，请：
1. 运行 `node verify-cogs-fix.js` 查看详细信息
2. 检查 `COGS_FIX_GUIDE.md` 中的故障排除章节
3. 查看本文档的"待处理项目"部分

---

**修复完成日期**: 2024-12-08
**修复内容**: 销售成本计算、库存同步、售完成本保留
**影响范围**: 损益报表、库存管理、成本计算
**符合标准**: 会计成本配比原则、历史成本原则
